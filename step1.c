// Hiding code in deterministically built binaries - Proof-of-Concept - Linux/x86
// Copyright (C) 2015 Christopher JÃ¤mthagen, Lund University
//
//   christopher.jamthagen@eit.lth.se
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.

#include "def.h"

int t1(imm8_t *a,int b)
{
}
int t2(int b)
{
}

void p1(imm8_t *a, imm32_t *b)
{
    //Part I
    //Uncomment to test the HEP of p1
    //asm(".byte 0xcc");
    asm(".byte 0xeb");  //Jump to first HEP fragment
    asm(".byte 0x05");

    /***************** 1 ********************************///
    a->a[JMP_REL8][0x66][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x66
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 2 ********************************///
    a->a[JMP_REL8][0x01][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x01
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 3 *****************************************///
    b->a[0x1b][0x49][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 4 ********************************///
    a->a[JMP_REL8][0x00][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x00
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 5 ********************************///
    a->a[JMP_REL8][0x01][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x01
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 6 ********************************///
    a->a[JMP_REL8][0x02][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x02
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 7 *******************************///
    a->a[0x20][JMP_REL8][PUSH_ESP] = 0;                //               PUSH ESP
    /************************************************///

    FILLER25

    /***************** 8 ***************************************///
    b->a[0x1a][0x35][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;    //       CALL epilogue
    /********************************************************///

    FILLER58

    /***************** 9 ********************************///
    a->a[JMP_REL8][0xc2][MOV_RM32_R32] = JMP_REL8;      //              MOV EDX, EAX
    t2(0xff);                                          //
    /************************************************///
    
    FILLER82
}

void p2(imm8_t *a, imm32_t *b)
{
    //Part II
    //Uncomment to test the HEP of p2
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** 10 ****************************************///
    a->a[JMP_REL8][0x66][PUSH_IMM8] = JMP_REL8;                  //     PUSH 0x66
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 11 ****************************************///
    a->a[JMP_REL8][0x0e][PUSH_IMM8] = JMP_REL8;                  //     PUSH 0x0E
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 12 ****************************************///
    b->a[0x17][0xfa][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 13 *******************************///
    a->a[JMP_REL8][0x04][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x04
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 14 ***************************///
    a->a[0x20][JMP_REL8][PUSH_ESP] = 0;             //                  PUSH ESP
    /*********************************************///

    FILLER25

    /***************** 15 *******************************///
    a->a[JMP_REL8][0x02][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x02
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 16 *******************************///
    a->a[JMP_REL8][0x01][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x01
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 17 ***************************///
    a->a[JMP_REL8][PUSH_ESP][PUSH_EDX] = JMP_REL8;  //                  PUSH EDX
    t2(0);                                         //                   PUSH ESP
    /********************************************///

    FILLER92

    /***************** 18 **************************************///
    b->a[0x16][0x76][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;    //       CALL epilogue
    /********************************************************///

    FILLER53
}

void p3(imm8_t *a, imm32_t *b)
{
    //Part III
    //Uncomment to test the HEP of p3
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** 19 ****************************************///
    a->a[JMP_REL8][0x66][PUSH_IMM8] = JMP_REL8;                  //     PUSH 0x66
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 20 *******************************///
    a->a[JMP_REL8][0x02][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x02
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 21 ****************************************///
    b->a[0x14][0xa9][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 22 *******************************///
    a->a[JMP_REL8][0x00][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x00
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 23 ***************************************///
    a->a[0x20][JMP_REL8][XCHG_ECX_EAX] = JMP_REL8;              //      XCHG ECX,EAX
    /*********************************************************///

    FILLER25

    /***************** 24 ****************************************///
    a->a[JMP_REL8][0xe0][MOV_RM32_R32] = JMP_REL8;               //     MOV EAX,ESP
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 25 ****************************************///
    a->a[PUSH_IMM8][DEC_EAX][DEC_EAX] = JMP_REL8;                //     DEC EAX
    t2(0);                                                      //      DEC EAX
    /*********************************************************///       PUSH 0x00

    FILLER90

    /***************** 26 ****************************************///
    b->a[MOV_RM8_IMM8][0x00][0x00] = FLAG22|(JMP_REL8<<8)|0x80;  //     MOVB [EAX],0x80
    /**********************************************************///       

    FILLER58

    /***************** 27 ****************************************///
    b->a[MOV_RM8_IMM8][DEC_EAX][DEC_EAX>>2] =                    //     DEC EAX
        FLAG22|(JMP_REL8<<8)|0x02;                              //      DEC EAX
    /*********************************************************///       MOVB [EAX],0x02

    FILLER58

    /***************** 28 ***************************************///
    a->a[0x20][JMP_REL8][XCHG_ECX_EAX] = 0;                     //      XCHG ECX,EAX
    /*********************************************************///

    FILLER25
    
    /***************** 29 *******************************///
    a->a[JMP_REL8][0xe1][MOV_RM32_R32] = JMP_REL8;      //              MOV ECX, ESP
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 30 *******************************///
    a->a[JMP_REL8][0x10][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x10
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 31 ***************************************///
    a->a[JMP_REL8][PUSH_EDX][PUSH_ECX] = JMP_REL8;              //      PUSH ECX
    t2(0);                                                     //       PUSH EDX
    /********************************************************///

    FILLER92
    
    /***************** 32 **************************************///
    a->a[0x20][JMP_REL8][PUSH_ESP] = 0;                        //       PUSH ESP
    /********************************************************///

    FILLER25

    /***************** 33 **************************************///
    b->a[0x11][0x73][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;    //       CALL epilogue
    /********************************************************///

    FILLER53
}

void p4(imm8_t *a, imm32_t *b)
{
    //Part IV
    //Uncomment to test the HEP of p4
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** 34 ****************************************///
    a->a[JMP_REL8][0x66][PUSH_IMM8] = JMP_REL8;                  //     PUSH 0x66
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 35 *******************************///
    a->a[JMP_REL8][0x04][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x04
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 36 ****************************************///
    b->a[0x0f][0xa6][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 37 ***************************************///
    a->a[JMP_REL8][0x00][PUSH_IMM8] = JMP_REL8;                 //      PUSH 0x00
    t2(0);                                                     //
    /********************************************************///

    FILLER92

    /***************** 38 ***************************///
    a->a[JMP_REL8][PUSH_ESP][PUSH_EDX] = JMP_REL8;  //                  PUSH EDX
    t2(0);                                         //                   PUSH ESP
    /********************************************///

    FILLER92

    /***************** 39 **************************************///
    b->a[0x0f][0x25][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;    //       CALL epilogue
    /********************************************************///

    FILLER53
}

void p5(imm8_t *a, imm32_t *b)
{
    //Part V
    //Uncomment to test the HEP of p5
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** 40 ****************************************///
    a->a[JMP_REL8][0x66][PUSH_IMM8] = JMP_REL8;                  //     PUSH 0x66
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 41 *******************************///
    a->a[JMP_REL8][0x05][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x05
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 42 ****************************************///
    b->a[0x0d][0x58][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 43 ***************************************///
    a->a[JMP_REL8][0x00][PUSH_IMM8] = JMP_REL8;                 //      PUSH 0x00
    t2(0);                                                     //
    /********************************************************///

    FILLER92
    
    /***************** 44 **************************************///
    a->a[JMP_REL8][0x00][PUSH_IMM8] = JMP_REL8;                //       PUSH 0x00
    t2(0);                                                    //
    /*******************************************************///

    FILLER92
    
    /***************** 45 ***************************///
    a->a[JMP_REL8][PUSH_ESP][PUSH_EDX] = JMP_REL8;  //                  PUSH EDX
    t2(0);                                         //                   PUSH ESP
    /********************************************///

    FILLER92

    /***************** 46 **************************************///
    b->a[0x0c][0x67][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;    //       CALL epilogue
    /********************************************************///
    
    FILLER58

    /***************** 47 *******************************///
    a->a[JMP_REL8][0xc2][MOV_RM32_R32] = JMP_REL8;      //              MOV EDX, EAX
    t2(0xff);                                          //
    /************************************************///
    
    FILLER82
}

void p6(imm8_t *a, imm32_t *b)
{
    //Part VI
    //Uncomment to test the HEP of p6
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** 48 *******************************///
    a->a[JMP_REL8][0x3f][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x3f
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 49 ***************************///
    a->a[0x20][JMP_REL8][PUSH_EDX] = 0;             //                  PUSH EDX
    /*********************************************///

    FILLER25

    /***************** 50 ****************************************///
    b->a[0x0a][0x79][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 51 ****************************************///
    a->a[JMP_REL8][0x00][PUSH_IMM8] = JMP_REL8;                  //     PUSH 0x00
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 52 ****************************************///
    b->a[0x0a][0x68][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL epilogue
    /**********************************************************///

    FILLER53
}

void p7(imm8_t *a, imm32_t *b)
{
    //Part VII
    //Uncomment to test the HEP of p7
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** 53 *******************************///
    a->a[JMP_REL8][0x3f][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x3f
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 54 ***************************///
    a->a[0x20][JMP_REL8][PUSH_EBX] = 0;             //                  PUSH EBX
    /*********************************************///

    FILLER25

    /***************** 55 ****************************************///
    b->a[0x08][0xe8][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 56 ****************************************///
    a->a[JMP_REL8][0x01][PUSH_IMM8] = JMP_REL8;                  //     PUSH 0x01
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 57 ****************************************///
    b->a[0x08][0xd7][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL epilogue
    /**********************************************************///

    FILLER53
}
void p8(imm8_t *a, imm32_t *b)
{
    //Part VIII
    //Uncomment to test the HEP of p8
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** 58 *******************************///
    a->a[JMP_REL8][0x3f][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x3f
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 59 ***************************///
    a->a[0x20][JMP_REL8][PUSH_EBX] = 0;             //                  PUSH EBX
    /*********************************************///

    FILLER25

    /***************** 60 ****************************************///
    b->a[0x07][0x57][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 61 ****************************************///
    a->a[JMP_REL8][0x02][PUSH_IMM8] = JMP_REL8;                  //     PUSH 0x02
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 62 ****************************************///
    b->a[0x07][0x46][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL epilogue
    /**********************************************************///

    FILLER53
}
void p9(imm8_t *a, imm32_t *b)
{
    //Part IX
    //Uncomment to test the HEP of p9
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** 63 *******************************///
    a->a[JMP_REL8][0x0b][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x0b
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 64 ***************************///
    a->a[0x20][JMP_REL8][PUSH_EBX] = 0;             //                  PUSH EBX
    /*********************************************///

    FILLER25

    /***************** 65 ****************************************///
    b->a[0x05][0xc6][CALL_REL32>>2] = (JMP_REL8<<8)|FLAG22;      //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 66 *******************************///
    a->a[JMP_REL8][0x00][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x00
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 67 *******************************///
    a->a[0x20][JMP_REL8][XCHG_EBX_EAX] = 0;             //              XCHG EBX, EAX
    /*************************************************///

    FILLER25

    /***************** 68 *******************************///
    a->a[JMP_REL8][0xe0][MOV_RM32_R32] = JMP_REL8;      //              MOV EAX, ESP
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 69 *******************************///
    a->a[JMP_REL8][PUSH_EDX][PUSH_ECX] = JMP_REL8;      //              PUSH EDX
    t2(0);                                             //               PUSH EDX
    /************************************************///

    FILLER91

    /***************** 70 ******************************************///
    b->a[MOV_RM8_IMM8][DEC_EAX][0x00] = FLAG22|(JMP_REL8<<8)|0x68; //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x68

    FILLER57

    /***************** 71 ******************************************///
    b->a[MOV_RM8_IMM8][DEC_EAX][0x00] = FLAG22|(JMP_REL8<<8)|0x73; //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x73

    FILLER57

    /***************** 72 ******************************************///
    b->a[MOV_RM8_IMM8][DEC_EAX][0x00] = FLAG22|(JMP_REL8<<8)|0x2f; //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x2f

    FILLER57

    /***************** 73 ******************************************///
    b->a[MOV_RM8_IMM8][DEC_EAX][0x00] = FLAG22|(JMP_REL8<<8)|0x2f; //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x2f

    FILLER57

    /***************** 74 ******************************************///
    b->a[MOV_RM8_IMM8][DEC_EAX][0x00] = FLAG22|(JMP_REL8<<8)|0x6e; //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x6e

    FILLER57

    /***************** 75 ******************************************///
    b->a[MOV_RM8_IMM8][DEC_EAX][0x00] = FLAG22|(JMP_REL8<<8)|0x69; //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x69

    FILLER57

    /***************** 76 ******************************************///
    b->a[MOV_RM8_IMM8][DEC_EAX][0x00] = FLAG22|(JMP_REL8<<8)|0x62; //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x62

    FILLER57

    /***************** 77 ******************************************///
    b->a[MOV_RM8_IMM8][DEC_EAX][0x00] = FLAG22|(JMP_REL8<<8)|0x2f; //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x2f

    FILLER58

    /***************** 78 *******************************///
    a->a[0x20][JMP_REL8][XCHG_EBX_EAX] = 0;             //              XCHG EBX, EAX
    /*************************************************///

    FILLER25

    /***************** 79 *******************************///
    a->a[JMP_REL8][0xe3][MOV_RM32_R32] = JMP_REL8;      //              MOV EBX, ESP
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 80 *******************************///
    a->a[JMP_REL8][0xd2][XOR_RM32_R32] = JMP_REL8;      //              XOR EDX, EDX
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 81 *******************************///
    a->a[JMP_REL8][0x00][PUSH_IMM8] = JMP_REL8;         //              PUSH 0x00
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 82 ****************************************///
    b->a[0x01][0x0f][CALL_REL32>>2] = 0;                         //     CALL epilogue
    /**********************************************************///

    FILLER92

}

void prologue(imm8_t *a, imm32_t *b)
{
    //Prologue
    //Uncomment to test the HEP of prologue
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** p1 *******************************///
    a->a[JMP_REL8][POP_EBX][POP_EDI] = JMP_REL8;        //              POP EDI
    t1((imm8_t*)a->a,FLAG27);                          //               POP EBX
    /************************************************///

    FILLER84

    /***************** p2 *******************************///            POP EAX
    b->a[RETN][PUSH_EDI][POP_EAX>>2] = 0;               //              PUSH EDI
    /*************************************************///               RETN

    FILLER38
}

void epilogue(imm8_t *a, imm32_t *b)
{
    //Epilogue
    //Uncomment to test the HEP of epilogue
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** e1 *******************************///
    a->a[JMP_REL8][POP_ECX][POP_EDI] = JMP_REL32;       //              POP EDI
    t1((imm8_t*)a->a,FLAG27);                          //               POP ECX
    /************************************************///       

    FILLER87

    /***************** e2 *******************************///
    a->a[JMP_REL8][0x80][INT_IMM8] = JMP_REL32;         //              INT 0x80
    t1((imm8_t*)a->a,FLAG27);                          //
    /************************************************///

    FILLER87

    /***************** e3 *******************************///
    a->a[0x0][RETN][PUSH_EDI] = 0;                      //              PUSH EDI
    /*************************************************///               RETN
}

int main(int argc, char **argv)
{
    imm8_t *a = malloc(sizeof(imm8_t));
    imm32_t *b = malloc(sizeof(imm32_t));
    p1(a,b);
    return 0;
}
