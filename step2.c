// Hiding code in deterministically built binaries - Proof-of-Concept - Linux/x86
// Copyright (C) 2015 Christopher JÃ¤mthagen, Lund University
//
//   christopher.jamthagen@eit.lth.se
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.

#include "def.h"

int t1(imm8_t *a,int b)
{
}
int t2(int b)
{
}

void p1(byte3_jmprel8_t *c, jmprel8_0x20_t *d, callrel32_t *f)
{
    //Part I
    //Uncomment to test the HEP of p1
    //asm(".byte 0xcc");
    asm(".byte 0xeb");  //Jump to first HEP fragment
    asm(".byte 0x05");

    /***************** 1 ********************************///
    c->pushimm8_0x66 = JMP_REL8;                        //              PUSH 0x66
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 2 ********************************///
    c->pushimm8_0x01 = JMP_REL8;                        //              PUSH 0x01
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 3 *****************************************///
    f->call_1b49 = (JMP_REL8<<8)|FLAG22;                         //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 4 ********************************///
    c->pushimm8_0x00 = JMP_REL8;                        //              PUSH 0x00
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 5 ********************************///
    c->pushimm8_0x01 = JMP_REL8;                        //              PUSH 0x01
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 6 ********************************///
    c->pushimm8_0x02 = JMP_REL8;                        //              PUSH 0x02
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 7 *******************************///
    d->pushesp = 0;                                    //               PUSH ESP
    /************************************************///

    FILLER25

    /***************** 8 ***************************************///
    f->call_1a35 = (JMP_REL8<<8)|FLAG22;                       //       CALL epilogue
    /********************************************************///

    FILLER58

    /***************** 9 ********************************///
    c->movrm32r32_0xc2 = JMP_REL8;                      //              MOV EDX, EAX
    t2(0xff);                                          //
    /************************************************///
    
    FILLER82
}

void p2(byte3_jmprel8_t *c, jmprel8_0x20_t *d, callrel32_t *f)
{
    //Part II
    //Uncomment to test the HEP of p2
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** 10 ****************************************///
    c->pushimm8_0x66 = JMP_REL8;                                 //     PUSH 0x66
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 11 ****************************************///
    c->pushimm8_0x0e = JMP_REL8;                                 //     PUSH 0x0E
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 12 ****************************************///
    f->call_17fa = (JMP_REL8<<8)|FLAG22;                         //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 13 *******************************///
    c->pushimm8_0x04 = JMP_REL8;                        //              PUSH 0x04
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 14 ***************************///
    d->pushesp = 0;                                 //                  PUSH ESP
    /*********************************************///

    FILLER25

    /***************** 15 *******************************///
    c->pushimm8_0x02 = JMP_REL8;                        //              PUSH 0x02
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 16 *******************************///
    c->pushimm8_0x01 = JMP_REL8;                        //              PUSH 0x01
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 17 ***************************///
    c->pushedx_pushesp = JMP_REL8;                  //                  PUSH EDX
    t2(0);                                         //                   PUSH ESP
    /********************************************///

    FILLER92

    /***************** 18 **************************************///
    f->call_1676 = (JMP_REL8<<8)|FLAG22;                       //       CALL epilogue
    /********************************************************///

    FILLER53
}

void p3(byte3_jmprel8_t *c, jmprel8_0x20_t *d, movrm8imm8_t *e, callrel32_t *f, pushimm8_deceax_deceax_t *g)
{
    //Part III
    //Uncomment to test the HEP of p3
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** 19 ****************************************///
    c->pushimm8_0x66 = JMP_REL8;                                 //     PUSH 0x66
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 20 *******************************///
    c->pushimm8_0x02 = JMP_REL8;                        //              PUSH 0x02
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 21 ****************************************///
    f->call_14a9 = (JMP_REL8<<8)|FLAG22;                         //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 22 *******************************///
    c->pushimm8_0x00 = JMP_REL8;                        //              PUSH 0x00
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 23 ***************************************///
    d->xchgecxeax = 0;                                          //      XCHG ECX,EAX
    /*********************************************************///

    FILLER25

    /***************** 24 ****************************************///
    c->movrm32r32_0xe0 = JMP_REL8;                               //     MOV EAX,ESP
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 25 ****************************************///
    g->pushimm8_deceax_deceax = JMP_REL8;                        //     DEC EAX
    t2(0);                                                      //      DEC EAX
    /*********************************************************///       PUSH 0x00

    FILLER90

    /***************** 26 ****************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x80;                //     MOVB [EAX],0x80
    /**********************************************************///       

    FILLER58

    /***************** 27 ***************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x02;               //      MOVB [EAX],0x02
    /*********************************************************///       

    FILLER58

    /***************** 28 ***************************************///
    d->xchgecxeax = 0;                                          //      XCHG ECX,EAX
    /*********************************************************///

    FILLER25
    
    /***************** 29 *******************************///
    c->movrm32r32_0xe1 = JMP_REL8;                      //              MOV ECX, ESP
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 30 *******************************///
    c->pushimm8_0x10 = JMP_REL8;                        //              PUSH 0x10
    t2(0);                                             //   
    /************************************************///

    FILLER92

    /***************** 31 ***************************************///
    c->pushecx_pushedx = JMP_REL8;                              //      PUSH ECX
    t2(0);                                                     //       PUSH EDX
    /********************************************************///

    FILLER92
    
    /***************** 32 **************************************///
    d->pushesp = 0;                                            //       PUSH ESP
    /********************************************************///

    FILLER25

    /***************** 33 **************************************///
    f->call_1173 = (JMP_REL8<<8)|FLAG22;                       //       CALL epilogue
    /********************************************************///

    FILLER53
}

void p4(byte3_jmprel8_t *c, callrel32_t *f)
{
    //Part IV
    //Uncomment to test the HEP of p4
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** 34 ****************************************///
    c->pushimm8_0x66 = JMP_REL8;                                 //     PUSH 0x66
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 35 *******************************///
    c->pushimm8_0x04 = JMP_REL8;                        //              PUSH 0x04
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 36 ****************************************///
    f->call_0fa6 = (JMP_REL8<<8)|FLAG22;                         //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 37 ***************************************///
    c->pushimm8_0x00 = JMP_REL8;                                //      PUSH 0x00
    t2(0);                                                     //
    /********************************************************///

    FILLER92

    /***************** 38 ***************************///
    c->pushedx_pushesp = JMP_REL8;                  //                  PUSH EDX
    t2(0);                                         //                   PUSH ESP
    /********************************************///

    FILLER92

    /***************** 39 **************************************///
    f->call_0f25 = (JMP_REL8<<8)|FLAG22;                       //       CALL epilogue
    /********************************************************///

    FILLER53
}

void p5(byte3_jmprel8_t *c, callrel32_t *f)
{
    //Part V
    //Uncomment to test the HEP of p5
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** 40 ****************************************///
    c->pushimm8_0x66 = JMP_REL8;                                 //     PUSH 0x66
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 41 *******************************///
    c->pushimm8_0x05 = JMP_REL8;                        //              PUSH 0x05
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 42 ****************************************///
    f->call_0d58 = (JMP_REL8<<8)|FLAG22;                         //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 43 ***************************************///
    c->pushimm8_0x00 = JMP_REL8;                                //      PUSH 0x00
    t2(0);                                                     //
    /********************************************************///

    FILLER92
    
    /***************** 44 **************************************///
    c->pushimm8_0x00 = JMP_REL8;                               //       PUSH 0x00
    t2(0);                                                    //
    /*******************************************************///

    FILLER92
    
    /***************** 45 ***************************///
    c->pushedx_pushesp = JMP_REL8;                  //                  PUSH EDX
    t2(0);                                         //                   PUSH ESP
    /********************************************///

    FILLER92

    /***************** 46 **************************************///
    f->call_0c67 = (JMP_REL8<<8)|FLAG22;                       //       CALL epilogue
    /********************************************************///
    
    FILLER58

    /***************** 47 *******************************///
    c->movrm32r32_0xc2 = JMP_REL8;                      //              MOV EDX, EAX
    t2(0xff);                                          //
    /************************************************///
    
    FILLER82
}

void p6(byte3_jmprel8_t *c, jmprel8_0x20_t *d, callrel32_t *f)
{
    //Part VI
    //Uncomment to test the HEP of p6
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** 48 *******************************///
    c->pushimm8_0x3f = JMP_REL8;                        //              PUSH 0x3f
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 49 ***************************///
    d->pushedx = 0;                                 //                  PUSH EDX
    /*********************************************///

    FILLER25

    /***************** 50 ****************************************///
    f->call_0a79 = (JMP_REL8<<8)|FLAG22;                         //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 51 ****************************************///
    c->pushimm8_0x00 = JMP_REL8;                                 //     PUSH 0x00
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 52 ****************************************///
    f->call_0a68 = (JMP_REL8<<8)|FLAG22;                         //     CALL epilogue
    /**********************************************************///

    FILLER53
}

void p7(byte3_jmprel8_t *c, jmprel8_0x20_t *d, callrel32_t *f)
{
    //Part VII
    //Uncomment to test the HEP of p7
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** 53 *******************************///
    c->pushimm8_0x3f = JMP_REL8;                        //              PUSH 0x3f
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 54 ***************************///
    d->pushebx = 0;                                 //                  PUSH EBX
    /*********************************************///

    FILLER25

    /***************** 55 ****************************************///
    f->call_08e8 = (JMP_REL8<<8)|FLAG22;                         //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 56 ****************************************///
    c->pushimm8_0x01 = JMP_REL8;                                 //     PUSH 0x01
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 57 ****************************************///
    f->call_08d7 = (JMP_REL8<<8)|FLAG22;                         //     CALL epilogue
    /**********************************************************///

    FILLER53
}
void p8(byte3_jmprel8_t *c, jmprel8_0x20_t *d, callrel32_t *f)
{
    //Part VIII
    //Uncomment to test the HEP of p8
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** 58 *******************************///
    c->pushimm8_0x3f = JMP_REL8;                        //              PUSH 0x3f
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 59 ***************************///
    d->pushebx = 0;                                 //                  PUSH EBX
    /*********************************************///

    FILLER25

    /***************** 60 ****************************************///
    f->call_0757 = (JMP_REL8<<8)|FLAG22;                         //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 61 ****************************************///
    c->pushimm8_0x02 = JMP_REL8;                                 //     PUSH 0x02
    t2(0);                                                      //
    /*********************************************************///

    FILLER92

    /***************** 62 ****************************************///
    f->call_0746 = (JMP_REL8<<8)|FLAG22;                         //     CALL epilogue
    /**********************************************************///

    FILLER53
}
void p9(byte3_jmprel8_t *c, jmprel8_0x20_t *d, movrm8imm8_t *e, callrel32_t *f)
{
    //Part IX
    //Uncomment to test the HEP of p9
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** 63 *******************************///
    c->pushimm8_0x0b = JMP_REL8;                        //              PUSH 0x0b
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 64 ***************************///
    d->pushebx = 0;                                 //                  PUSH EBX
    /*********************************************///

    FILLER25

    /***************** 65 ****************************************///
    f->call_05c6 = (JMP_REL8<<8)|FLAG22;                         //     CALL prologue
    /**********************************************************///

    FILLER58

    /***************** 66 *******************************///
    c->pushimm8_0x00 = JMP_REL8;                        //              PUSH 0x00
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 67 *******************************///
    d->xchgebxeax = 0;                                  //              XCHG EBX, EAX
    /*************************************************///

    FILLER25

    /***************** 68 *******************************///
    c->movrm32r32_0xe0 = JMP_REL8;                      //              MOV EAX, ESP
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 69 *******************************///
    c->pushecx_pushedx = JMP_REL8;                      //              PUSH EDX
    t2(0);                                             //               PUSH EDX
    /************************************************///

    FILLER91

    /***************** 70 ******************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x68;                  //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x68

    FILLER57

    /***************** 71 ******************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x73;                  //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x73

    FILLER57

    /***************** 72 ******************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x2f;                  //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x2f

    FILLER57

    /***************** 73 ******************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x2f;                  //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x2f

    FILLER57

    /***************** 74 ******************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x6e;                  //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x6e

    FILLER57

    /***************** 75 ******************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x69;                  //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x69

    FILLER57

    /***************** 76 ******************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x62;                  //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x62

    FILLER57

    /***************** 77 ******************************************///
    e->deceax_deceax = FLAG22|(JMP_REL8<<8)|0x2f;                  //   DEC EAX
    /************************************************************///    MOV BYTE [EAX], 0x2f

    FILLER58

    /***************** 78 *******************************///
    d->xchgebxeax = 0;                                  //              XCHG EBX, EAX
    /*************************************************///

    FILLER25

    /***************** 79 *******************************///
    c->movrm32r32_0xe3 = JMP_REL8;                      //              MOV EBX, ESP
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 80 *******************************///
    c->xorrm32r32_0xd2 = JMP_REL8;                      //              XOR EDX, EDX
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 81 *******************************///
    c->pushimm8_0x00 = JMP_REL8;                        //              PUSH 0x00
    t2(0);                                             //
    /************************************************///

    FILLER92

    /***************** 82 ****************************************///
    f->call_010f = (JMP_REL8<<8)|FLAG22;                         //     CALL epilogue
    /**********************************************************///

    FILLER92

}

void prologue(byte3_jmprel8_t *c, imm8_t *a, retn_pushedi_popeax_t *f)
{
    //Prologue
    //Uncomment to test the HEP of prologue
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");

    /***************** p1 *******************************///
    c->popedi_popebx = JMP_REL8;                        //              POP EDI
    t1((imm8_t*)a->a,FLAG27);                          //               POP EBX
    /************************************************///

    FILLER84

    /***************** p2 *******************************///            POP EAX
    f->popeax_pushedi_retn = 0;                         //              PUSH EDI
    /*************************************************///               RETN

    FILLER38
}

void epilogue(byte3_jmprel8_t *c, imm8_t *a, retn_pushedi_popeax_t *f)
{
    //Epilogue
    //Uncomment to test the HEP of epilogue
    //asm(".byte 0xcc");
    //asm(".byte 0xeb");
    //asm(".byte 0x05");
    
    /***************** e1 *******************************///
    c->popedi_popecx = JMP_REL32;                       //              POP EDI
    t1((imm8_t*)a->a,FLAG27);                          //               POP ECX
    /************************************************///       

    FILLER87

    /***************** e2 *******************************///
    c->intimm8_0x80 = JMP_REL32;                        //              INT 0x80
    t1((imm8_t*)a->a,FLAG27);                          //
    /************************************************///

    FILLER86

    /***************** e3 *******************************///
    f->popeax_pushedi_retn = 0;                         //              PUSH EDI
    /*************************************************///               RETN
}

int main(int argc, char **argv)
{
    jmprel8_0x20_t *d = malloc(sizeof(jmprel8_0x20_t));
    byte3_jmprel8_t *c = malloc(sizeof(byte3_jmprel8_t));
    callrel32_t *f = malloc(sizeof(callrel32_t));
    p1(c,d,f);
    return 0;
}
